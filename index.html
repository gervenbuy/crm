<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>迪特軍維修管理系統</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- html2canvas for Image Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Print Styles */
        @media print {
            body {
                background-color: white;
                margin: 0;
                padding: 0;
            }
            .no-print {
                display: none !important;
            }
            .print-wrapper { 
                position: static !important; 
                overflow: visible !important; 
                height: auto !important; 
                width: 100% !important; 
                display: block !important; 
                background: white !important; 
                z-index: 9999;
            }
            .print-content { 
                margin: 0 auto !important; 
                padding: 0 !important; 
                width: 210mm !important; 
                min-height: 297mm !important; 
                transform: scale(0.95); 
                transform-origin: top center; 
                box-shadow: none !important; 
                border: none !important; 
            }
            @page { 
                size: A4 portrait; 
                margin: 0; 
            }
        }

        /* Utility for print overlay */
        #print-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f3f4f6;
            z-index: 50;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        
        #print-overlay.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between sticky top-0 z-40 no-print">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 text-white p-1.5 rounded-lg">
                <i data-lucide="wrench" width="20" height="20"></i>
            </div>
            <span class="font-bold text-xl tracking-tight">迪特軍 <span class="text-gray-400 font-normal text-sm ml-1">維修管理系統</span></span>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="window.app.openImportModal()" class="text-gray-500 hover:text-indigo-600 text-sm flex items-center gap-1">
                <i data-lucide="upload" width="16" height="16"></i> 匯入資料
            </button>
            <button onclick="window.app.exportToCSV()" class="text-gray-500 hover:text-indigo-600 text-sm flex items-center gap-1">
                <i data-lucide="download" width="16" height="16"></i> 匯出資料表
            </button>
            <div class="h-8 w-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500">
                <i data-lucide="user" width="18" height="18"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto p-6 no-print">
        
        <!-- View: List -->
        <div id="view-list" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-3 bg-white p-2 rounded-lg border border-gray-200 shadow-sm flex items-center">
                    <i data-lucide="search" class="text-gray-400 ml-2" width="20" height="20"></i>
                    <input type="text" id="search-input" placeholder="輸入客戶電話、姓名或車身序號搜尋..." class="w-full p-2 outline-none text-gray-700" oninput="window.app.handleSearch(this.value)">
                </div>
                <button onclick="window.app.startAddCustomer()" class="bg-indigo-600 text-white rounded-lg shadow-sm hover:bg-indigo-700 flex items-center justify-center gap-2 font-medium transition py-2">
                    <i data-lucide="plus" width="18" height="18"></i> 新增客戶
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left">
                        <thead class="bg-gray-50 text-gray-600 font-medium border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-sm">類別</th>
                                <th class="px-6 py-3 text-sm">客戶姓名</th>
                                <th class="px-6 py-3 text-sm">電話</th>
                                <th class="px-6 py-3 text-sm">車型</th>
                                <th class="px-6 py-3 text-sm">保固狀態</th>
                                <th class="px-6 py-3 text-sm text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="customer-list-body" class="divide-y divide-gray-100">
                            <!-- JS will populate rows here -->
                            <tr><td colspan="6" class="text-center py-8">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- View: Form (Add/Edit) -->
        <div id="view-form" class="hidden bg-white p-6 rounded-xl shadow border border-gray-200 animate-in fade-in slide-in-from-top-4 duration-300">
            <div class="flex justify-between mb-4">
                <h2 id="form-title" class="text-lg font-bold">建立新客戶資料</h2>
                <button onclick="window.app.setView('list')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" width="20" height="20"></i></button>
            </div>
            <form id="customer-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Category -->
                <div class="md:col-span-2 bg-gray-50 p-3 rounded-lg flex gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">客戶類別：</span>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="category" value="purchase" class="text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="text-sm text-gray-900">購車客戶 (含完整保固)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="category" value="repair" class="text-indigo-600 focus:ring-indigo-500">
                        <span class="text-sm text-gray-900">純維修客戶</span>
                    </label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">客戶電話 (ID)</label>
                    <input type="tel" name="phone" required class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0912345678">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">客戶姓名</label>
                    <input type="text" name="name" required class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">車輛型號</label>
                    <input type="text" name="model" required class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="例如: Gogoro 2, Ai-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">車身序號 (VIN)</label>
                    <input type="text" name="vin" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none font-mono">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">規格/顏色</label>
                    <input type="text" name="specs" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">交車金額</label>
                    <input type="number" name="price" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">購車日期</label>
                        <input type="date" name="purchaseDate" required class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">保固天數</label>
                        <input type="number" name="warrantyDays" required value="365" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                    <textarea name="notes" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none h-20"></textarea>
                </div>
                <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                    <button type="button" onclick="window.app.setView('list')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">取消</button>
                    <button type="submit" class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800 flex items-center gap-2">
                        <i data-lucide="save" width="16" height="16"></i> <span id="form-submit-text">儲存資料</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- View: Detail -->
        <div id="view-detail" class="hidden space-y-6">
            <div class="flex items-center justify-between">
                <button onclick="window.app.setView('list')" class="flex items-center text-gray-600 hover:text-gray-900">
                    <i data-lucide="chevron-left" width="20" height="20"></i> 返回列表
                </button>
                <div class="flex gap-2">
                    <button onclick="window.app.startEditCustomer()" class="flex items-center gap-2 bg-gray-100 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 transition" title="編輯資料">
                        <i data-lucide="pencil" width="18" height="18"></i>
                    </button>
                    <button onclick="window.app.promptDeleteCustomer()" class="flex items-center gap-2 bg-red-50 text-red-600 px-3 py-2 rounded-lg hover:bg-red-100 transition" title="刪除客戶">
                        <i data-lucide="trash-2" width="18" height="18"></i>
                    </button>
                    <div class="w-px h-8 bg-gray-300 mx-1"></div>
                    <button onclick="window.app.showPrintPreview('receipt')" class="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition shadow-sm">
                        <i data-lucide="file-signature" width="18" height="18"></i> 交車簽收單
                    </button>
                    <button onclick="window.app.showPrintPreview('warranty')" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm">
                        <i data-lucide="printer" width="18" height="18"></i> 保固卡
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Info Card -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                    <div id="detail-category-tag" class="absolute top-0 right-0 px-4 py-1 rounded-bl-xl text-sm font-bold"></div>
                    <div class="flex justify-between items-start mb-4 mt-2">
                        <div>
                            <h2 id="detail-name" class="text-2xl font-bold text-gray-800"></h2>
                            <p id="detail-phone" class="text-gray-500 font-mono text-lg"></p>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600" id="detail-info-grid">
                        <!-- Info populated by JS -->
                    </div>
                </div>

                <!-- Add Record Form -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="wrench" class="text-indigo-600" width="18" height="18"></i> 新增維修/保養紀錄
                    </h3>
                    <form id="record-form" class="space-y-4">
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" class="record-type-btn p-2 rounded border text-sm flex flex-col items-center justify-center gap-1 border-gray-200 hover:bg-gray-50" data-type="regular" onclick="window.app.setRecordType('regular')">
                                <i data-lucide="calendar" width="16" height="16"></i> 定期保養
                            </button>
                            <button type="button" class="record-type-btn p-2 rounded border text-sm flex flex-col items-center justify-center gap-1 border-gray-200 hover:bg-gray-50" data-type="battery" onclick="window.app.setRecordType('battery')">
                                <i data-lucide="battery" width="16" height="16"></i> 更換電池
                            </button>
                            <button type="button" class="record-type-btn p-2 rounded border text-sm flex flex-col items-center justify-center gap-1 border-gray-200 hover:bg-gray-50" data-type="repair" onclick="window.app.setRecordType('repair')">
                                <i data-lucide="wrench" width="16" height="16"></i> 故障維修
                            </button>
                        </div>
                        <input type="hidden" id="record-type-input" value="regular">
                        <textarea id="record-note" placeholder="維修備註、更換項目、里程數..." required class="w-full border border-gray-300 rounded-lg p-2 text-sm h-20 focus:ring-2 focus:ring-indigo-500 focus:outline-none"></textarea>
                        <button type="submit" class="w-full bg-gray-900 text-white py-2 rounded-lg hover:bg-black transition">儲存紀錄</button>
                    </form>
                </div>
            </div>

            <!-- History List -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4">服務歷史紀錄</h3>
                <div class="overflow-hidden">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500">
                            <tr>
                                <th class="px-4 py-2">日期</th>
                                <th class="px-4 py-2">類型</th>
                                <th class="px-4 py-2">內容</th>
                                <th class="px-4 py-2 text-right w-20">操作</th>
                            </tr>
                        </thead>
                        <tbody id="history-list-body" class="divide-y divide-gray-100">
                            <!-- Records populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Print Overlay -->
    <div id="print-overlay">
        <!-- Control Bar -->
        <div class="w-full bg-gray-900 text-white p-4 flex justify-between items-center sticky top-0 shadow-md z-50 no-print">
            <button onclick="window.app.closePrintPreview()" class="flex items-center gap-2 hover:text-gray-300 transition font-bold">
                <i data-lucide="arrow-left" width="20" height="20"></i> 返回系統
            </button>
            <div class="text-sm flex items-center gap-4">
                <button onclick="window.app.downloadPrintImage()" id="btn-download-img" class="bg-green-600 px-4 py-2 rounded hover:bg-green-500 transition cursor-pointer select-none active:scale-95 flex items-center gap-2 font-bold disabled:opacity-50">
                    <i data-lucide="image" width="18" height="18"></i> 下載圖片
                </button>
                <button onclick="window.print()" class="bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-500 transition cursor-pointer select-none active:scale-95 flex items-center gap-2">
                    <i data-lucide="printer" width="18" height="18"></i> 列印
                </button>
            </div>
        </div>
        
        <!-- Print Content Container (A4) -->
        <div class="flex-1 w-full flex justify-center p-8 overflow-visible">
            <div id="print-content-node" class="print-content bg-white shadow-2xl relative" style="width: 210mm; min-height: 297mm; padding: 15mm;">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <dialog id="confirm-modal" class="rounded-lg p-0 shadow-xl backdrop:bg-black/50">
        <div class="bg-white p-6 max-w-sm w-full">
            <h3 id="confirm-title" class="text-lg font-bold mb-2 text-gray-900">確認</h3>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('confirm-modal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">取消</button>
                <button id="confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm transition">確認刪除</button>
            </div>
        </div>
    </dialog>

    <dialog id="import-modal" class="rounded-xl p-0 shadow-2xl backdrop:bg-black/50 w-full max-w-2xl">
        <div class="bg-white p-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="upload" class="text-indigo-600"></i> 批次匯入客戶資料
                </h3>
                <button onclick="document.getElementById('import-modal').close()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-6">
                <div class="bg-blue-50 p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="text-sm font-bold text-blue-800 mb-1">步驟 1：下載範本</p>
                        <p class="text-xs text-blue-600">請使用 Excel 或 Google Sheet 編輯後儲存為 CSV 格式。</p>
                    </div>
                    <button onclick="window.app.downloadTemplate()" class="text-sm bg-white text-blue-600 border border-blue-200 px-3 py-1.5 rounded hover:bg-blue-50 shadow-sm flex items-center gap-1">
                        <i data-lucide="download" width="14" height="14"></i> 下載 CSV 範本
                    </button>
                </div>
                <div>
                    <p class="text-sm font-bold text-gray-800 mb-2">步驟 2：上傳檔案</p>
                    <input type="file" accept=".csv" onchange="window.app.handleFileSelect(this)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer border border-gray-300 rounded-lg p-2">
                    <p id="import-error" class="text-red-500 text-sm mt-2"></p>
                </div>
                <div id="import-preview" class="hidden">
                    <p class="text-sm font-bold text-gray-800 mb-2">預覽資料 (前 3 筆)</p>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="min-w-full text-xs text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2">姓名</th>
                                    <th class="px-3 py-2">電話</th>
                                    <th class="px-3 py-2">車型</th>
                                    <th class="px-3 py-2">類別</th>
                                </tr>
                            </thead>
                            <tbody id="import-preview-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button onclick="document.getElementById('import-modal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">取消</button>
                    <button id="start-import-btn" onclick="window.app.executeImport()" disabled class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-sm transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        開始匯入
                    </button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Logic Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Config & Init ---
        // REPLACE WITH YOUR ACTUAL CONFIG IF NOT IN ENV
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let currentUser = null;
        let customers = [];
        let selectedCustomerId = null;
        let importData = [];
        let formMode = 'add'; // 'add' or 'edit'

        // --- Constants ---
        const WARRANTY_TERMS = [
            "本保固僅限於正常使用下之原廠零件瑕疵。",
            "泡水、涉水深度超過輪軸導致的電子零件損壞不在保固範圍內。",
            "電池長期未充電導致深度放電（假死）、電壓過低無法喚醒，屬人為疏失，不在保固範圍內。",
            "使用非原廠充電器導致的電池或電路板損壞，或過度充電導致的膨脹，不在保固範圍內。",
            "自行改裝控制器、馬達、解限速或變更電路系統導致的損壞。",
            "車輛發生交通事故、碰撞、跌倒導致的外觀與結構損壞。",
            "消耗性零件（如：輪胎、煞車皮、燈泡、保險絲、皮帶/鍊條）之自然磨損。",
            "因天災（如颱風、淹水、地震）等不可抗力因素造成之損壞。",
            "營業用途（如外送、快遞）之高強度使用，部分零件保固期可能縮短或不適用。",
            "未按原廠建議週期回廠保養，導致機械零件潤滑不足或功能異常。"
        ];

        // --- Helpers ---
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);
        
        const formatDate = (dateStr) => {
            if (!dateStr || dateStr === '-') return '-';
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? '-' : d.toLocaleDateString('zh-TW');
        };

        const formatCurrency = (amount) => {
            if (amount === undefined || amount === null || isNaN(amount)) return '-';
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        };

        const calculateWarranty = (purchaseDate, warrantyDays) => {
            if (!purchaseDate) return { isValid: false, remainingDays: 0, endDate: '-' };
            const start = new Date(purchaseDate);
            if (isNaN(start.getTime())) return { isValid: false, remainingDays: 0, endDate: '-' };
            
            const end = new Date(start);
            end.setDate(start.getDate() + (warrantyDays || 0));
            
            const today = new Date();
            const diffTime = end.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return {
                isValid: diffDays > 0,
                remainingDays: diffDays > 0 ? diffDays : 0,
                endDate: end.toISOString().split('T')[0]
            };
        };

        // --- DOM Render Functions ---
        
        // 1. Render List
        const renderCustomerList = (searchTerm = '') => {
            const tbody = document.getElementById('customer-list-body');
            tbody.innerHTML = '';

            const filtered = customers.filter(c => 
                (c.phone && c.phone.includes(searchTerm)) || 
                (c.name && c.name.includes(searchTerm)) ||
                (c.vin && c.vin.includes(searchTerm))
            );

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">沒有找到符合的資料</td></tr>';
                return;
            }

            filtered.forEach(c => {
                const w = calculateWarranty(c.purchaseDate, c.warrantyDays);
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition group cursor-pointer border-b border-gray-100";
                tr.onclick = () => showDetail(c.id);
                
                const categoryClass = c.category === 'repair' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800';
                const categoryText = c.category === 'repair' ? '維修' : '購車';
                const warrantyText = w.isValid ? `保固中 (${w.remainingDays}天)` : '已過期/無';
                const warrantyClass = w.isValid ? 'text-green-600 font-medium' : 'text-gray-400';

                tr.innerHTML = `
                    <td class="px-6 py-4"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${categoryClass}">${categoryText}</span></td>
                    <td class="px-6 py-4 font-medium text-gray-900">${c.name || '-'}</td>
                    <td class="px-6 py-4 text-gray-500 font-mono">${c.phone || '-'}</td>
                    <td class="px-6 py-4 text-gray-600">${c.model || '-'}</td>
                    <td class="px-6 py-4 text-gray-600"><span class="text-xs ${warrantyClass}">${warrantyText}</span></td>
                    <td class="px-6 py-4 text-right"><span class="text-indigo-600 text-sm font-medium opacity-0 group-hover:opacity-100 transition">查看 &gt;</span></td>
                `;
                tbody.appendChild(tr);
            });
        };

        // 2. Show/Hide Views
        const setView = (viewName) => {
            document.getElementById('view-list').classList.add('hidden');
            document.getElementById('view-form').classList.add('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            
            if (viewName === 'list') {
                document.getElementById('view-list').classList.remove('hidden');
                renderCustomerList(document.getElementById('search-input').value);
            } else if (viewName === 'form') {
                document.getElementById('view-form').classList.remove('hidden');
            } else if (viewName === 'detail') {
                document.getElementById('view-detail').classList.remove('hidden');
                renderCustomerDetail();
            }
            lucide.createIcons();
        };

        // 3. Render Detail
        const renderCustomerDetail = () => {
            const customer = customers.find(c => c.id === selectedCustomerId);
            if (!customer) return;

            const w = calculateWarranty(customer.purchaseDate, customer.warrantyDays);
            
            // Set Header
            const tag = document.getElementById('detail-category-tag');
            tag.className = `absolute top-0 right-0 px-4 py-1 rounded-bl-xl text-sm font-bold ${customer.category === 'repair' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`;
            tag.textContent = customer.category === 'repair' ? '維修客戶' : '購車客戶';
            
            document.getElementById('detail-name').textContent = customer.name;
            document.getElementById('detail-phone').textContent = customer.phone;

            // Info Grid
            const infoGrid = document.getElementById('detail-info-grid');
            const warrantyBadge = w.isValid 
                ? `<div class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs font-bold flex items-center gap-1"><i data-lucide="check-circle" width="12"></i> 保固中 (剩 ${w.remainingDays} 天)</div>`
                : `<div class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs font-bold flex items-center gap-1"><i data-lucide="alert-circle" width="12"></i> 保固已過期 / 無保固</div>`;

            infoGrid.innerHTML = `
                <div class="flex justify-between border-b border-gray-100 pb-2"><span>車型/規格:</span><span class="font-medium text-gray-900">${customer.model} / ${customer.specs}</span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span>車身序號 (VIN):</span><span class="font-mono text-gray-900">${customer.vin || '-'}</span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span>購車日期:</span><span class="font-medium text-gray-900">${formatDate(customer.purchaseDate)}</span></div>
                <div class="flex justify-between border-b border-gray-100 pb-2"><span>交車金額:</span><span class="font-bold text-gray-900 text-base">${formatCurrency(customer.price)}</span></div>
                <div class="flex justify-between pt-1 items-center"><span>保固狀態:</span>${warrantyBadge}</div>
                <div class="mt-4 p-2 bg-gray-50 rounded text-xs text-gray-500">備註: ${customer.notes || '無'}</div>
            `;

            // Records List
            const historyBody = document.getElementById('history-list-body');
            historyBody.innerHTML = '';
            
            if (customer.records && customer.records.length > 0) {
                customer.records.forEach(rec => {
                    let typeClass = 'bg-blue-100 text-blue-800';
                    let typeName = '定期保養';
                    if (rec.type === 'battery') { typeClass = 'bg-green-100 text-green-800'; typeName = '更換電池'; }
                    if (rec.type === 'repair') { typeClass = 'bg-orange-100 text-orange-800'; typeName = '故障維修'; }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-gray-600 whitespace-nowrap">${new Date(rec.date).toLocaleDateString('zh-TW')}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-bold ${typeClass}">${typeName}</span></td>
                        <td class="px-4 py-3 text-gray-800">${rec.notes}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="window.app.deleteRecord('${rec.id}')" class="text-gray-400 hover:text-red-600 p-1 transition"><i data-lucide="trash-2" width="16"></i></button>
                        </td>
                    `;
                    historyBody.appendChild(row);
                });
            } else {
                historyBody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400">尚無紀錄</td></tr>';
            }
            lucide.createIcons();
        };

        // --- Logic Actions ---

        window.app = {
            setView,
            
            handleSearch: (val) => {
                renderCustomerList(val);
            },

            // Form Actions
            startAddCustomer: () => {
                formMode = 'add';
                document.getElementById('form-title').textContent = '建立新客戶資料';
                document.getElementById('form-submit-text').textContent = '建立資料';
                document.getElementById('customer-form').reset();
                // Set default date
                document.querySelector('input[name="purchaseDate"]').value = new Date().toISOString().split('T')[0];
                setView('form');
            },

            startEditCustomer: () => {
                const c = customers.find(x => x.id === selectedCustomerId);
                if (!c) return;
                
                formMode = 'edit';
                document.getElementById('form-title').textContent = '編輯客戶資料';
                document.getElementById('form-submit-text').textContent = '儲存變更';
                
                const form = document.getElementById('customer-form');
                form.name.value = c.name;
                form.phone.value = c.phone;
                form.model.value = c.model;
                form.vin.value = c.vin || '';
                form.specs.value = c.specs || '';
                form.price.value = c.price || 0;
                form.purchaseDate.value = c.purchaseDate;
                form.warrantyDays.value = c.warrantyDays;
                form.notes.value = c.notes || '';
                
                // Radio
                const radios = form.elements['category'];
                for (let i=0; i<radios.length; i++) {
                    if (radios[i].value === c.category) radios[i].checked = true;
                }

                setView('form');
            },

            promptDeleteCustomer: () => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-title').textContent = '刪除客戶資料';
                document.getElementById('confirm-message').textContent = '確定要刪除這位客戶的資料嗎？此動作無法復原。';
                
                document.getElementById('confirm-btn').onclick = async () => {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'customers', selectedCustomerId));
                        modal.close();
                        selectedCustomerId = null;
                        setView('list');
                    } catch (err) {
                        alert('刪除失敗');
                    }
                };
                modal.showModal();
            },

            // Record Actions
            setRecordType: (type) => {
                document.getElementById('record-type-input').value = type;
                // Update UI styles for buttons
                document.querySelectorAll('.record-type-btn').forEach(btn => {
                    if (btn.dataset.type === type) {
                        // Apply active style based on type
                        if(type==='regular') btn.className = 'record-type-btn p-2 rounded border text-sm flex flex-col items-center justify-center gap-1 bg-blue-50 border-blue-500 text-blue-700';
                        if(type==='battery') btn.className = 'record-type-btn p-2 rounded border text-sm flex flex-col items-center justify-center gap-1 bg-green-50 border-green-500 text-green-700';
                        if(type==='repair') btn.className = 'record-type-btn p-2 rounded border text-sm flex flex-col items-center justify-center gap-1 bg-orange-50 border-orange-500 text-orange-700';
                    } else {
                        btn.className = 'record-type-btn p-2 rounded border text-sm flex flex-col items-center justify-center gap-1 border-gray-200 hover:bg-gray-50';
                    }
                });
            },

            deleteRecord: (recordId) => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-title').textContent = '刪除維修紀錄';
                document.getElementById('confirm-message').textContent = '確定要刪除這筆維修紀錄嗎？';
                
                document.getElementById('confirm-btn').onclick = async () => {
                    try {
                        const c = customers.find(x => x.id === selectedCustomerId);
                        const newRecords = c.records.filter(r => r.id !== recordId);
                        await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'customers', selectedCustomerId), {
                            records: newRecords
                        });
                        modal.close();
                    } catch (err) {
                        alert('刪除紀錄失敗');
                    }
                };
                modal.showModal();
            },

            // Print Actions
            showPrintPreview: (type) => {
                const c = customers.find(x => x.id === selectedCustomerId);
                if (!c) return;
                
                const w = calculateWarranty(c.purchaseDate, c.warrantyDays);
                const overlay = document.getElementById('print-overlay');
                const content = document.getElementById('print-content-node');
                
                // Bike SVG string
                const bikeSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bike"><circle cx="18.5" cy="17.5" r="3.5"/><circle cx="5.5" cy="17.5" r="3.5"/><circle cx="15" cy="5" r="1"/><path d="M12 17.5V14l-3-3 4-3 2 3h2"/></svg>`;

                if (type === 'warranty') {
                    // Generate Warranty Card HTML
                    const termsHtml = WARRANTY_TERMS.map((t,i) => `<li>${t}</li>`).join('');
                    content.innerHTML = `
                        <div class="border-4 border-double border-gray-800 p-8 h-full relative flex flex-col justify-between">
                            <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none overflow-hidden">${bikeSvg}</div>
                            <div class="relative z-10">
                                <div class="text-center mb-12 mt-4">
                                    <h1 class="text-5xl font-bold tracking-widest mb-4">產品保固證書</h1>
                                    <p class="text-2xl text-gray-600">迪特軍 - 專業電動車服務</p>
                                </div>
                                <div class="grid grid-cols-2 gap-12 mb-12 text-xl">
                                    <div class="space-y-8">
                                        <div class="border-b-2 border-gray-300 pb-2 flex items-end"><span class="font-bold text-gray-800 w-28 flex-shrink-0">客戶姓名：</span><span class="font-medium flex-1">${c.name}</span></div>
                                        <div class="border-b-2 border-gray-300 pb-2 flex items-end"><span class="font-bold text-gray-800 w-28 flex-shrink-0">聯絡電話：</span><span class="font-medium flex-1">${c.phone}</span></div>
                                        <div class="border-b-2 border-gray-300 pb-2 flex items-end"><span class="font-bold text-gray-800 w-28 flex-shrink-0">車輛型號：</span><span class="font-medium flex-1">${c.model}</span></div>
                                    </div>
                                    <div class="space-y-8">
                                        <div class="border-b-2 border-gray-300 pb-2 flex items-end"><span class="font-bold text-gray-800 w-28 flex-shrink-0">購車日期：</span><span class="font-medium flex-1">${formatDate(c.purchaseDate)}</span></div>
                                        <div class="border-b-2 border-gray-300 pb-2 flex items-end"><span class="font-bold text-gray-800 w-28 flex-shrink-0">保固期限：</span><span class="font-medium flex-1">${formatDate(w.endDate)} <span class="text-base text-gray-500">(${c.warrantyDays} 天)</span></span></div>
                                        <div class="border-b-2 border-gray-300 pb-2 flex items-end"><span class="font-bold text-gray-800 w-28 flex-shrink-0">車身序號：</span><span class="font-mono font-medium flex-1">${c.vin || '-'}</span></div>
                                    </div>
                                </div>
                                <div class="mb-8">
                                    <h3 class="text-xl font-bold border-l-8 border-black pl-4 mb-6">保固條款與除外責任</h3>
                                    <ul class="list-disc pl-6 space-y-2 text-base text-gray-800 leading-relaxed text-justify">${termsHtml}</ul>
                                </div>
                            </div>
                            <div class="text-right relative z-10 mt-8 mb-4">
                                <div class="inline-block text-center">
                                    <p class="font-bold text-lg text-gray-600 mb-8 text-left">店章 / 簽名處</p>
                                    <div class="w-72 h-32 border-2 border-dashed border-gray-400 rounded-lg bg-white bg-opacity-50"></div>
                                    <p class="text-xs text-gray-400 mt-2 text-right">列印日期: ${new Date().toLocaleDateString()}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Generate Receipt HTML
                    const termsShort = WARRANTY_TERMS.slice(0, 5).map((t,i) => `<div class="mb-1">${i+1}. ${t}</div>`).join('');
                    content.innerHTML = `
                        <div class="border-4 border-gray-800 p-8 h-full relative flex flex-col justify-between">
                            <div>
                                <div class="text-center mb-10 border-b-2 border-gray-800 pb-6">
                                    <h1 class="text-4xl font-bold tracking-widest mb-2">交車簽收單</h1>
                                    <p class="text-xl text-gray-600">迪特軍 - 專業電動車服務</p>
                                    <div class="absolute top-0 right-0 text-sm text-gray-500 mt-2">單號: ${c.id.substring(0,8).toUpperCase()}</div>
                                </div>
                                <div class="grid grid-cols-2 gap-x-12 gap-y-6 mb-8 text-lg">
                                    <div class="col-span-2 bg-gray-100 p-2 font-bold text-center border border-gray-300">客戶資料</div>
                                    <div class="flex border-b border-gray-300 pb-1"><span class="font-bold w-24">客戶大名：</span><span class="flex-1">${c.name}</span></div>
                                    <div class="flex border-b border-gray-300 pb-1"><span class="font-bold w-24">聯絡電話：</span><span class="flex-1">${c.phone}</span></div>
                                    <div class="col-span-2 bg-gray-100 p-2 font-bold text-center border border-gray-300 mt-4">車輛資料</div>
                                    <div class="flex border-b border-gray-300 pb-1"><span class="font-bold w-24">車輛型號：</span><span class="flex-1">${c.model}</span></div>
                                    <div class="flex border-b border-gray-300 pb-1"><span class="font-bold w-24">車身序號：</span><span class="flex-1 font-mono">${c.vin || '-'}</span></div>
                                    <div class="flex border-b border-gray-300 pb-1"><span class="font-bold w-24">規格顏色：</span><span class="flex-1">${c.specs || '-'}</span></div>
                                    <div class="flex border-b border-gray-300 pb-1"><span class="font-bold w-24">交車金額：</span><span class="flex-1 font-bold text-xl">${formatCurrency(c.price)}</span></div>
                                </div>
                                <div class="mb-8">
                                    <div class="bg-gray-800 text-white p-2 font-bold mb-4">交車保固說明與檢核確認</div>
                                    <div class="text-sm text-gray-800 space-y-3 leading-relaxed border border-gray-300 p-4">
                                        <p class="font-bold">請確認以下項目：</p>
                                        <ul class="list-none space-y-2 pl-2">
                                            <li>□ 車輛外觀檢查無刮傷、無損壞。</li>
                                            <li>□ 各項功能操作正常（燈光、儀表、煞車、動力系統）。</li>
                                            <li>□ 隨車配件、鑰匙、充電器材點收無誤。</li>
                                            <li>□ 已清楚了解並同意以下保固條款：</li>
                                        </ul>
                                        <div class="pl-6 text-xs text-gray-600 mt-2 border-t border-dashed border-gray-300 pt-2">
                                            ${termsShort}
                                            <div class="italic text-gray-400">... (完整條款請參閱保固證書)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8">
                                <div class="border border-gray-400 p-6">
                                    <p class="text-sm font-bold mb-8">本人確認上述車輛及配件點收無誤，並已詳閱且同意保固條款內容。</p>
                                    <div class="flex justify-between items-end h-32">
                                        <div class="w-1/2 text-center border-r border-gray-300 pr-4"><p class="text-gray-500 mb-16 text-left">店家人員簽章：</p><div class="border-b border-black"></div></div>
                                        <div class="w-1/2 text-center pl-4"><p class="text-gray-500 mb-16 text-left">客戶簽名：</p><div class="border-b border-black"></div></div>
                                    </div>
                                </div>
                                <p class="text-xs text-center text-gray-400 mt-2">交車日期: ${new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                    `;
                }

                overlay.classList.add('active');
            },

            closePrintPreview: () => {
                document.getElementById('print-overlay').classList.remove('active');
            },

            downloadPrintImage: async () => {
                const content = document.getElementById('print-content-node');
                const btn = document.getElementById('btn-download-img');
                btn.textContent = "生成中...";
                btn.disabled = true;

                try {
                    const canvas = await html2canvas(content, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        windowWidth: content.scrollWidth,
                        windowHeight: content.scrollHeight
                    });
                    const image = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `Document-${Date.now()}.png`;
                    link.click();
                } catch (err) {
                    console.error(err);
                    alert("圖片生成失敗");
                } finally {
                    btn.innerHTML = '<i data-lucide="image" width="18" height="18"></i> 下載圖片';
                    btn.disabled = false;
                    lucide.createIcons();
                }
            },

            // Import/Export
            openImportModal: () => document.getElementById('import-modal').showModal(),
            
            downloadTemplate: () => {
                const headers = "姓名,電話,車型,車身序號,規格,購車日期(YYYY-MM-DD),保固天數,交車金額,類別(購車/維修),備註";
                const example = "王小明,0912345678,Gogoro 2,VIN123456789,白色,2024-01-01,730,85000,購車,這是範例資料";
                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers + "\n" + example;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "customer_import_template.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            handleFileSelect: (input) => {
                const file = input.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const rows = text.split('\n').map(r => r.trim()).filter(r => r);
                    if (rows.length < 2) {
                        document.getElementById('import-error').textContent = "格式錯誤";
                        return;
                    }
                    
                    const data = rows.slice(1).map(row => {
                        const cols = row.split(',');
                        let pDate = cols[5]?.trim();
                        if (!pDate || isNaN(new Date(pDate).getTime())) pDate = new Date().toISOString().split('T')[0];
                        
                        return {
                            name: cols[0]?.trim() || '未命名',
                            phone: cols[1]?.trim() || '',
                            model: cols[2]?.trim() || '',
                            vin: cols[3]?.trim() || '',
                            specs: cols[4]?.trim() || '',
                            purchaseDate: pDate,
                            warrantyDays: parseInt(cols[6]?.trim()) || 365,
                            price: parseInt(cols[7]?.trim()) || 0,
                            category: (cols[8]?.trim() === '維修' ? 'repair' : 'purchase'),
                            notes: cols[9]?.trim() || ''
                        };
                    }).filter(i => i.name && i.phone);

                    importData = data;
                    
                    // Preview
                    const previewBody = document.getElementById('import-preview-body');
                    previewBody.innerHTML = '';
                    importData.slice(0, 3).forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = "border-t";
                        tr.innerHTML = `<td class="px-3 py-2">${item.name}</td><td class="px-3 py-2">${item.phone}</td><td class="px-3 py-2">${item.model}</td><td class="px-3 py-2">${item.category==='repair'?'維修':'購車'}</td>`;
                        previewBody.appendChild(tr);
                    });
                    
                    document.getElementById('import-preview').classList.remove('hidden');
                    document.getElementById('start-import-btn').disabled = false;
                };
                reader.readAsText(file);
            },

            executeImport: async () => {
                const btn = document.getElementById('start-import-btn');
                btn.textContent = "匯入中...";
                btn.disabled = true;
                
                try {
                    const batch = writeBatch(db);
                    const ref = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'customers');
                    // Process max 450
                    const chunk = importData.slice(0, 450);
                    
                    chunk.forEach(item => {
                        const newRef = doc(ref);
                        batch.set(newRef, { ...item, records: [], createdAt: Timestamp.now() });
                    });
                    
                    await batch.commit();
                    alert(`成功匯入 ${chunk.length} 筆資料`);
                    document.getElementById('import-modal').close();
                } catch (err) {
                    alert('匯入失敗');
                    console.error(err);
                } finally {
                    btn.textContent = "開始匯入";
                    btn.disabled = false;
                }
            },

            exportToCSV: () => {
                const headers = ["類別", "姓名", "電話", "車型", "序號(VIN)", "規格", "購車日", "保固天數", "交車金額", "備註"];
                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(",") + "\n" + customers.map(c => {
                    const cat = c.category === 'repair' ? '維修客戶' : '購車客戶';
                    return `${cat},${c.name},'${c.phone},${c.model},${c.vin},${c.specs},${c.purchaseDate},${c.warrantyDays},${c.price || 0},${c.notes}`;
                }).join("\n");
                
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "customer_data_export.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // --- Event Listeners ---
        
        // Show Customer Detail helper (attached to window.app not needed, local scope is tricky)
        window.showDetail = (id) => {
            selectedCustomerId = id;
            setView('detail');
        };

        document.getElementById('customer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd.entries());
            
            // Format types
            data.price = parseInt(data.price) || 0;
            data.warrantyDays = parseInt(data.warrantyDays) || 365;

            try {
                if (formMode === 'add') {
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'customers'), {
                        ...data,
                        records: [],
                        createdAt: Timestamp.now()
                    });
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'customers', selectedCustomerId), data);
                }
                setView('list');
            } catch (err) {
                alert('儲存失敗');
                console.error(err);
            }
        });

        document.getElementById('record-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const note = document.getElementById('record-note').value;
            const type = document.getElementById('record-type-input').value;
            
            const c = customers.find(x => x.id === selectedCustomerId);
            const newRecord = {
                id: generateId(),
                date: new Date().toISOString(),
                type: type,
                notes: note
            };
            
            const updatedRecords = [newRecord, ...(c.records || [])];
            
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'customers', selectedCustomerId), {
                    records: updatedRecords
                });
                document.getElementById('record-note').value = '';
            } catch (err) {
                alert('新增紀錄失敗');
            }
        });

        // --- Init ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Init listener
                const q = query(
                    collection(db, 'artifacts', appId, 'users', user.uid, 'customers'),
                    orderBy('createdAt', 'desc')
                );
                onSnapshot(q, (snapshot) => {
                    customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // If in detail view, refresh it
                    if (!document.getElementById('view-detail').classList.contains('hidden')) {
                        // Check if current selected still exists
                        if (!customers.find(c => c.id === selectedCustomerId)) {
                            setView('list');
                        } else {
                            renderCustomerDetail();
                        }
                    } else if (!document.getElementById('view-list').classList.contains('hidden')) {
                        renderCustomerList(document.getElementById('search-input').value);
                    }
                });
            } else {
                signInAnonymously(auth);
            }
        });

        // Initialize Icons
        lucide.createIcons();
    </script>
</body>
</html>